# Phase 2 Day 4: Git Integration

## Context

You're implementing the final day of Phase 2 for the Spec-Driven Development Platform. Days 1-3 are complete. Now we're adding Git integration - each spec gets its own branch and can create a PR.

**Read the full spec:** `.handoff/spec-driven-dev-mvp.md` (specifically "Phase 2: Multi-Spec Workflow" → "4. Git Integration" section)

## What Exists (Days 1-3 Complete)

- Multiple specs per project with status badges
- Individual chunk execution with GLM
- Review loop with Opus (pass/needs_fix/fail)
- Run All: sequential execution with auto-review
- Spec status tracking: draft/ready/running/review/completed/merged

## Day 4 Goal

Each spec gets its own git branch. After all chunks pass, user can create a PR with one click.

## Flow

```
Spec created → (optional) Branch created →
    ↓
Chunks execute (all changes on branch) →
    ↓
All chunks pass → "Create PR" button →
    ↓
PR created with spec title + description →
    ↓
PR merged → Spec status = 'merged'
```

## Tasks

### 1. Git API Routes

The placeholder routes exist at `/api/projects/[id]/git/`. Move them to spec-level:

**Create branch:**
```
POST /api/specs/[id]/git/branch
```

Request: `{ baseBranch?: string }` (defaults to current branch or 'main')

Response:
```json
{
  "branchName": "spec/abc123-add-user-auth",
  "created": true
}
```

Logic:
1. Generate branch name: `spec/{specId}-{slugified-title}`
2. Run: `git checkout -b {branchName}` in project directory
3. Update spec.branchName in database
4. Return branch name

**Commit changes:**
```
POST /api/specs/[id]/git/commit
```

Request: `{ message?: string }` (auto-generates from spec title if not provided)

Response:
```json
{
  "commitHash": "abc123",
  "message": "feat: Add user authentication",
  "filesChanged": 5
}
```

Logic:
1. Get project directory from spec → project
2. Run: `git add -A && git commit -m "{message}"` in project directory
3. Return commit info

**Create PR:**
```
POST /api/specs/[id]/git/pr
```

Request: `{ title?: string, body?: string, baseBranch?: string }`

Response:
```json
{
  "prNumber": 42,
  "prUrl": "https://github.com/user/repo/pull/42"
}
```

Logic:
1. Generate PR title from spec.title if not provided
2. Generate PR body from spec content + chunks list
3. Run: `gh pr create --title "{title}" --body "{body}" --base {baseBranch}`
4. Parse PR number and URL from output
5. Update spec.prNumber and spec.prUrl in database
6. Return PR info

### 2. PR Body Template

```markdown
## {spec.title}

{spec.content}

---

### Chunks Completed
- [x] {chunk1.title}
- [x] {chunk2.title}
- [x] {chunk3.title}

---
*Generated by Spec-Driven Dev Platform*
```

### 3. Branch Name Generation

```typescript
function generateBranchName(specId: string, title: string): string {
  const slug = title
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, '-')
    .replace(/^-|-$/g, '')
    .slice(0, 40);
  return `spec/${specId.slice(0, 8)}-${slug}`;
}
```

Example: `spec/abc12345-add-user-authentication`

### 4. Completion UI

After all chunks pass (via Run All or individual), show completion panel:

```
┌─────────────────────────────────────────────────────────────────┐
│  ✓ All chunks completed successfully!                           │
│                                                                 │
│  Ready to create PR?                                            │
│                                                                 │
│  Branch: spec/abc123-add-user-authentication                    │
│  Commits: 5                                                     │
│  Files changed: 12                                              │
│                                                                 │
│  [Create PR] [Commit Only] [Skip]                               │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

Create `packages/dashboard/src/components/SpecCompletePanel.tsx`:

```typescript
interface SpecCompletePanelProps {
  spec: Spec;
  project: Project;
  onCreatePR: () => Promise<void>;
  onCommitOnly: () => Promise<void>;
  onSkip: () => void;
}
```

### 5. Update Spec Workspace

Modify `packages/dashboard/src/app/project/[id]/spec/[specId]/page.tsx`:

- Show SpecCompletePanel when spec.status === 'completed'
- Add git action buttons in header when branch exists
- Show PR link when prUrl exists

Header additions:
```tsx
{spec.branchName && (
  <span className="text-xs text-neutral-500 font-mono">
    {spec.branchName}
  </span>
)}

{spec.prUrl && (
  <a
    href={spec.prUrl}
    target="_blank"
    className="text-xs text-blue-400 hover:text-blue-300 font-mono"
  >
    PR #{spec.prNumber}
  </a>
)}
```

### 6. Git Status Helper

Create utility to check git status in project directory:

```typescript
// packages/dashboard/src/lib/git.ts

export async function getGitStatus(directory: string): Promise<{
  branch: string;
  hasChanges: boolean;
  filesChanged: number;
  isClean: boolean;
}>;

export async function checkGitRepo(directory: string): Promise<boolean>;
```

### 7. Auto-Create Branch on First Run

When a chunk is first executed for a spec without a branch:
1. Auto-create branch
2. Update spec.branchName
3. Continue with execution

Add to run chunk logic or make it explicit via UI.

### 8. Update Spec Status on PR Merge

Option A: Manual - User clicks "Mark as Merged" button
Option B: Webhook - GitHub webhook updates status (complex, skip for MVP)

**Recommend Option A** for MVP:

Add "Mark as Merged" button when PR exists:
```tsx
{spec.prNumber && spec.status !== 'merged' && (
  <button onClick={handleMarkMerged}>
    Mark as Merged
  </button>
)}
```

### 9. Error Handling

Handle git errors gracefully:
- Not a git repo: Show warning, disable git features
- No GitHub CLI: Show install instructions
- Not authenticated: Prompt to run `gh auth login`
- Branch already exists: Offer to switch or create new
- Uncommitted changes: Warn before branch switch

## Git Command Execution

Use child_process to run git commands:

```typescript
import { exec } from 'child_process';
import { promisify } from 'util';

const execAsync = promisify(exec);

async function runGitCommand(
  directory: string,
  command: string
): Promise<{ stdout: string; stderr: string }> {
  return execAsync(command, { cwd: directory });
}
```

## Acceptance Criteria

- [ ] Can create branch for a spec
- [ ] Branch name follows pattern: `spec/{id}-{slug}`
- [ ] Can commit changes with auto-generated message
- [ ] Can create PR via GitHub CLI
- [ ] PR body includes spec content and chunks list
- [ ] Spec stores branchName, prNumber, prUrl
- [ ] Completion panel shows after all chunks pass
- [ ] PR link displayed in spec header
- [ ] "Mark as Merged" updates spec status
- [ ] Graceful error handling for git issues

## Notes

- Terminal theme: emerald-400 accents
- pnpm always
- Requires `gh` CLI installed for PR creation
- Test in actual git repo with GitHub remote
- Don't break non-git projects (graceful degradation)
