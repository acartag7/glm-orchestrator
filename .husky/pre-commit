#!/bin/sh

# Prevent committing secrets
echo "üîç Checking for secrets..."

# Get staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
  exit 0
fi

FOUND_SECRETS=0

for FILE in $STAGED_FILES; do
  if [ -f "$FILE" ]; then
    # npm tokens
    if grep -qE 'npm_[a-zA-Z0-9]{30,}' "$FILE" 2>/dev/null; then
      echo "‚ùå NPM token found in $FILE"
      FOUND_SECRETS=1
    fi

    # Resend API keys
    if grep -qE 're_[a-zA-Z0-9_]{20,}' "$FILE" 2>/dev/null; then
      echo "‚ùå Resend API key found in $FILE"
      FOUND_SECRETS=1
    fi

    # z.ai / Anthropic tokens (hex.base64 format)
    if grep -qE '[0-9a-f]{32}\.[a-zA-Z0-9]{16,}' "$FILE" 2>/dev/null; then
      echo "‚ùå API token (z.ai/Anthropic format) found in $FILE"
      FOUND_SECRETS=1
    fi

    # Generic API key assignments
    if grep -qiE '(API_KEY|AUTH_TOKEN|SECRET_KEY|PRIVATE_KEY)\s*=\s*["\x27][a-zA-Z0-9_-]{20,}["\x27]' "$FILE" 2>/dev/null; then
      echo "‚ùå Hardcoded credential found in $FILE"
      FOUND_SECRETS=1
    fi
  fi
done

if [ $FOUND_SECRETS -eq 1 ]; then
  echo ""
  echo "‚õî Commit blocked: Secrets detected!"
  echo ""
  echo "Options:"
  echo "  1. Remove the secret and use environment variables"
  echo "  2. Add file to .gitignore"
  echo "  3. Skip check: git commit --no-verify (use carefully!)"
  echo ""
  exit 1
fi

echo "‚úÖ No secrets detected"
